'use strict';

exports.main = async (event, context) => {
	let str;
	
	console.log('接收到的完整event:', JSON.stringify(event));
	
	let sourceEvent = event;
	if (event.args) {
		sourceEvent = event.args;
	}
	
	if (sourceEvent.queryStringParameters && sourceEvent.queryStringParameters.str) {
		str = sourceEvent.queryStringParameters.str;
		console.log('从queryStringParameters获取参数');
	} else if (sourceEvent.body) {
		try {
			let body = sourceEvent.body;
			if (typeof body === 'string') {
				body = JSON.parse(body);
			}
			str = body.str;
			console.log('从body获取参数:', { str });
		} catch (e) {
			console.error('解析body失败:', e);
			str = sourceEvent.str;
		}
	} else {
		str = sourceEvent.str;
		console.log('从event根级别获取参数');
	}
	
	console.log('最终参数 - str:', str);
	
	if (!str) {
		return {
			success: false,
			errMsg: '消息内容不能为空'
		};
	}
	
	try {
		const COZE_CONFIG = {
			WORKFLOW_ID: "7608559188160462888",
			API_KEY: "pat_IPMrHuorKKLv7ynXhPoxbyieHts346jnIemI63da9Apt9loCg8QTb1CSrYI53Ul0",
			API_URL: "https://api.coze.cn/v1/workflow/stream_run"
		};
		
		const db = uniCloud.database();
		const conversations = db.collection('coze-talk-conversations');
		const userId = "default_user";
		
		let historyMessages = [];
		try {
			const existingSession = await conversations
				.where({ user_id: userId })
				.get();
			
			if (existingSession.data.length > 0) {
				historyMessages = existingSession.data[0].messages || [];
				console.log('获取历史消息数量:', historyMessages.length);
			}
		} catch (dbError) {
			console.error('获取会话信息失败:', dbError);
		}
		
		const cleanedStrForAPI = str.replace(/（按需调用find-medicine工作流和插件）/g, '').trim();
		
		const requestData = {
			workflow_id: COZE_CONFIG.WORKFLOW_ID,
			parameters: {
				input: cleanedStrForAPI
			}
		};
		
		console.log('发送给Coze工作流API的请求数据:', JSON.stringify(requestData));
		
		const response = await uniCloud.httpclient.request(COZE_CONFIG.API_URL, {
			method: 'POST',
			headers: {
				'Authorization': `Bearer ${COZE_CONFIG.API_KEY}`,
				'Content-Type': 'application/json',
				'Accept': 'text/event-stream'
			},
			data: requestData,
			dataType: 'text',
			timeout: 300000
		});
		
		console.log('Coze工作流API完整响应:', JSON.stringify(response));
		
		let assistantReply = '';
		
		if (response.data) {
			const events = response.data.split('\n\n').filter(event => event.trim());
			
			for (const event of events) {
				const lines = event.split('\n');
				let eventType = '';
				let eventData = '';
				
				for (const line of lines) {
					if (line.startsWith('event:')) {
						eventType = line.substring(6).trim();
					} else if (line.startsWith('data:')) {
						eventData += line.substring(5).trim();
					}
				}
				
				if (eventData) {
					try {
						const dataObj = JSON.parse(eventData);
						
						if (eventType === 'Message' && dataObj.content) {
							assistantReply += dataObj.content;
						}
					} catch (parseError) {
						console.error('解析SSE数据失败:', parseError);
					}
				}
			}
		}
		
		console.log('提取的reply:', assistantReply);
		
		if (assistantReply) {
			const halfLength = Math.floor(assistantReply.length / 2);
			if (halfLength > 0) {
				const firstHalf = assistantReply.substring(0, halfLength);
				const secondHalf = assistantReply.substring(halfLength);
				if (firstHalf.trim() === secondHalf.trim()) {
					assistantReply = firstHalf;
					console.log('检测到整个内容重复，已去除重复部分');
				}
			}
			
			const contentLines = assistantReply.split('\n');
			const seenLines = new Set();
			const finalCleanLines = [];
			
			for (const line of contentLines) {
				const trimmedLine = line.trim();
				if (trimmedLine && !seenLines.has(trimmedLine)) {
					seenLines.add(trimmedLine);
					finalCleanLines.push(line);
				} else if (!trimmedLine) {
					finalCleanLines.push(line);
				}
			}
			
			assistantReply = finalCleanLines.join('\n');
			assistantReply = assistantReply.trim();
		}
		
		const cleanedStr = str.replace(/（按需调用find-medicine工作流和插件）/g, '').trim();
		
		const sessionMessages = [
			{
				role: "user",
				content: cleanedStr,
				content_type: "text",
				type: "question"
			},
			{
				role: "assistant",
				content: assistantReply,
				content_type: "text",
				type: "answer"
			}
		];
		
		try {
			const existingSession = await conversations
				.where({ user_id: userId })
				.get();
			
			let updatedMessages = [...historyMessages, ...sessionMessages];
			
			while (updatedMessages.length > 10) {
				updatedMessages.shift();
			}
			
			if (existingSession.data.length > 0) {
				await conversations
					.where({ user_id: userId })
					.update({
						messages: updatedMessages,
						updated_at: new Date()
					});
				console.log('会话更新成功，当前消息数:', updatedMessages.length);
			} else {
				await conversations.add({
					user_id: userId,
					messages: updatedMessages,
					meta_data: {},
					created_at: new Date(),
					updated_at: new Date()
				});
				console.log('会话创建成功');
			}
		} catch (dbError) {
			console.error('保存会话到数据库失败:', dbError);
		}
		
		return {
			success: true,
			data: {
				reply: assistantReply
			}
		};
	} catch (error) {
		console.error('调用Coze工作流API失败:', error);
		return {
			success: false,
			errMsg: error.message || '调用Coze工作流API失败'
		};
	}
};
